{% extends '_base.html' %}
{% load humanize %}
{% block page_title %} Ù¾Ø±Ø´ÛŒÙ† Ú¯ÛŒÙ…Ø²|Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ {% endblock %}


{% block page_content %}


      <main class="flex-grow bg-background pb-14 pt-36 xs:pt-36">
        <div class="container pb-14">
          <div class="grid grid-cols-12 gap-2 lg:gap-6">
            <!-- breadCrumb -->
            <div class="col-span-12 rounded-lg bg-muted">
              <ol class="grid grid-cols-3 overflow-hidden rounded-lg">
                <li
                  class="flex flex-col items-center justify-center gap-2 bg-primary/10 p-4 text-xs text-primary /10 sm:text-sm md:text-base"
                >
                  <svg class="h-6 w-6 md:h-8 md:w-8">
                    <use xlink:href="#cart" />
                  </svg>
                  <p class="leading-none">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</p>
                </li>
                <li
                  class="flex flex-col items-center justify-center gap-2 p-4 text-xs text-primary opacity-50 sm:text-sm md:text-base"
                >
                  <svg class="h-6 w-6 md:h-8 md:w-8">
                    <use xlink:href="#delivery-truck" />
                  </svg>
                  <p class="leading-none">ØªÚ©Ù…ÛŒÙ„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</p>
                </li>
                <li
                  class="flex flex-col items-center justify-center gap-2 p-4 text-xs text-primary opacity-50 sm:text-sm md:text-base"
                >
                  <svg class="h-6 w-6 md:h-8 md:w-8">
                    <use xlink:href="#credit" />
                  </svg>

                  <p class="leading-none">Ù¾Ø±Ø¯Ø§Ø®Øª</p>
                </li>
              </ol>
            </div>

            <!-- Cart List -->
            <div class="col-span-12 md:col-span-8">
              <div class="rounded-lg bg-muted p-4">
                <!-- Heading -->
                <div class="flex items-center justify-between gap-x-2 pb-4">
                  <h1
                    class="flex items-center gap-x-4 text-sm xs:text-base md:text-lg"
                  >
                    Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
                    <span class="text-sm text-text/60"> ( {{ cart.items.count }} Ú©Ø§Ù„Ø§ ) </span>
                  </h1>
                    <form action="{% url 'cart-delete' %}" method="post">
                        {% csrf_token %}
                  <button type="submit" class="btn-red-nobg px-3 py-2 text-sm">
                    <span>
                      <svg class="h-6 w-6">
                        <use xlink:href="#trash"></use>
                      </svg>
                    </span>
                    <span>Ø­Ø°Ù Ù‡Ù…Ù‡</span>
                  </button>
                        </form>
                </div>
                        {% if not cart.items.all %}

                  <div class="text-center py-10">
    <div class="text-5xl mb-3">ğŸ›’ğŸ’¨</div>
    <h2 class="text-lg font-bold">Ø³Ø¨Ø¯Øª Ø®Ø§Ù„ÛŒÙ‡!</h2>
    <p class="text-gray-600 mb-4">Ù‡ÛŒÚ† Ù…Ø­ØµÙˆÙ„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ú©Ø±Ø¯ÛŒ. Ø¨ÛŒØ§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒÙ… ğŸ˜Š</p>
    <a href="{% url 'products' %}" class="btn-primary">ÙØ±ÙˆØ´Ú¯Ø§Ù‡</a>
</div>
      {% endif %}

                <ul class="divide-y">
                  <!-- Cart Item-->
                    {% for item in cart.items.all %}
                  <li>
                    <div class="py-4 sm:py-6">
                      <div
                        class="grid grid-cols-2 items-center justify-start gap-2 xs:grid-cols-3 xs:gap-6 sm:grid-cols-4 xl:grid-cols-6"
                      >
                        <!-- Image -->
                        <div class="relative row-span-2 min-w-fit xs:mx-auto">
                          <a href="{{ item.product.get_absolute_url }}">
                            <img
                              alt=""
                              class="w-25 rounded-lg sm:w-28"
                              src="{{ item.product.image.url }}"
                            />
                          </a>
                            <form action="{% url 'cart-remove' item.id %}" method="post">
                                {% csrf_token %}
                          <button
                            class="absolute -right-2 -top-2 flex h-8 w-8 items-center justify-center rounded-full bg-background"
                            type="submit"
                          >
                            <svg class="h-6 w-6 text-red-600 dark:text-red-500">
                              <use xlink:href="#close"></use>
                            </svg>
                          </button>
                                </form>
                        </div>
                        <!-- Detail -->
                        <div
                          class="row-span-2 space-y-4 xs:col-span-2 sm:col-span-3 xl:col-span-5"
                        >
                          <!-- Title -->
                          <a class="line-clamp-2 text-sm xs:text-base" href="{{ item.product.get_absolute_url }}">
                            {{ item.product.title }}
                          </a>
                          <!-- Variant -->
                          <div class="flex items-center gap-x-2">
                              {% if item.product.type == 'A' %}
                            <span class="text-xs text-text/90 xs:text-sm">
                              {{ item.capacity }}</span
                            >
                              {% endif %}
                          </div>
                        </div>
                        <!-- Quantity -->
                        <div
                          class="flex items-center gap-x-2 xs:justify-center"
                        >
                          <div
                            class="flex h-10 w-24 items-center justify-between gap-x-3 rounded-lg border py-1 sm:w-28"
                          >
                            <button type="button" data-action="increment">
                              <svg class="h-5 w-5 text-primary sm:h-6 sm:w-6">
                                <use xlink:href="#plus" />
                              </svg>
                            </button>
                            <input
                              value="{{ item.quantity }}"
                              disabled
                              type="number"
                              class="flex h-5 w-5 select-none items-center justify-center bg-transparent text-center text-sm font-medium outline-none sm:h-6 sm:w-6 sm:text-lg"
                            />
                            <button type="button" data-action="decrement">
                              <svg
                                class="h-5 w-5 text-red-600 dark:text-red-500 sm:h-6 sm:w-6"
                              >
                                <use xlink:href="#minus" />
                              </svg>
                            </button>
                          </div>
                        </div>
                        <!-- Price -->
                          {% if item.product.type == 'A' %}
            <div class="text-primary xs:col-span-2 sm:col-span-3 lg:text-lg xl:col-span-5 space-y-1">
              <!-- Ù‚ÛŒÙ…Øª Ø§ØµÙ„ÛŒ Ø¨Ø§ ØªØ®ÙÛŒÙ -->
                {% if item.capacity.discount %}
              <div class="flex items-center gap-x-2">
                <del class="text-sm text-text/60 decoration-warning md:text-base">{{ item.capacity.price }}</del>
                <p class="w-9 rounded-full bg-warning py-px text-center text-sm text-white">{{ item.capacity.discount }}%</p>
              </div>
                {% endif %}

              <!-- Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ -->
              <div>
                <span class="font-bold">{{ item.capacity.final_price|floatformat|intcomma }}</span>
                <span class="text-sm lg:text-base">ØªÙˆÙ…Ø§Ù†</span>
              </div>
            </div>
            {% else %}
            <div class="text-primary xs:col-span-2 sm:col-span-3 lg:text-lg xl:col-span-5 space-y-1">
              <!-- Ù‚ÛŒÙ…Øª Ø§ØµÙ„ÛŒ Ø¨Ø§ ØªØ®ÙÛŒÙ -->
                {% if item.product.discount %}
              <div class="flex items-center gap-x-2">
                <del class="text-sm text-text/60 decoration-warning md:text-base">{{ item.product.price }}</del>
                <p class="w-9 rounded-full bg-warning py-px text-center text-sm text-white">{{ item.product.discount }}</p>
              </div>
                {% endif %}

              <!-- Ù‚ÛŒÙ…Øª Ù†Ù‡Ø§ÛŒÛŒ -->
              <div>
                <span class="font-bold">{{ item.item_final_price|floatformat|intcomma }}</span>
                <span class="text-sm lg:text-base">ØªÙˆÙ…Ø§Ù†</span>
              </div>
            </div>
            {% endif %}
                      </div>
                    </div>
                  </li>
                    {% endfor %}
                </ul>
              </div>
            </div>
            <!-- Cart Price Detail -->
            <div class="col-span-12 md:col-span-4">
              <!-- Desktop -->
                      {% if cart.items.all %}

              <div class="hidden rounded-lg bg-muted p-4 md:block">
                <div class="mb-2 divide-y">
                  <!-- cart items price before discount - coupon -->
                  <div class="flex items-center justify-between gap-x-2 py-6">
                    <div class="text-sm text-text/90 lg:text-base">
                      Ù‚ÛŒÙ…Øª Ú©Ø§Ù„Ø§ Ù‡Ø§ ({{ cart.items.count }})
                    </div>

                    <div class="text-sm text-primary lg:text-base">
                      <span class="font-bold">{{ cart.cart_org_total|floatformat|intcomma }}</span>
                      <span class="text-xs lg:text-sm">ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                  </div>

                  <!-- Discount -->
                  <div class="flex items-center justify-between gap-x-2 py-6">
                    <div class="text-sm text-text/90 lg:text-base">ØªØ®ÙÛŒÙ</div>

                    <div
                      class="text-sm font-medium text-red-500 dark:text-red-400 lg:text-base"
                    >
                      <span class="font-bold">{{ cart.cart_discount|floatformat|intcomma }}</span>
                      <span class="text-xs lg:text-sm">ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                  </div>
                  <!-- Order final price -->

                  <div class="flex items-center justify-between gap-x-2 py-6">
                    <div class="text-sm text-text/90 lg:text-base">
                      Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª
                    </div>

                    <div class="text-sm text-primary lg:text-base">
                      <span class="font-bold">{{ cart.cart_final_price|floatformat|intcomma }}</span>
                      <span class="text-xs lg:text-sm">ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                  </div>
                </div>
                <div>
                  <a
                          {% if user.is_authenticated %}
                          id="checkout-btn-desktop"
                          {% else %}
                          href="{% url 'login' %}?next={% url 'cart' %}"
                          {% endif %}
                          class="btn-primary py-3">
                    Ø§Ø¯Ø§Ù…Ù‡ ÙØ±Ø§ÛŒÙ†Ø¯ Ø®Ø±ÛŒØ¯
                  </a>
                </div>
              </div>
                      {% endif %}

              <!-- Mobile -->
              <div
                class="fixed inset-x-0 bottom-0 flex items-center gap-x-6 rounded-t-2xl bg-muted p-4 md:hidden"
              >
                <a
                  class="btn-primary flex-grow py-3"
                  href="checkout-shipping.html"
                >
                  Ø§Ø¯Ø§Ù…Ù‡ ÙØ±Ø§ÛŒÙ†Ø¯ Ø®Ø±ÛŒØ¯</a
                >
                <div class="flex flex-col items-center gap-y-1">
                  <div class="text-sm text-text/60">Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</div>
                  <div class="text-text/90">
                    <span class="font-bold">1,200,000</span>
                    <span class="text-sm">ØªÙˆÙ…Ø§Ù†</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>


          <!-- âœ… Bottom bar (Mobile fixed bar) -->
                {% if cart.items.all %}

<div
  id="mobile-summary-bar"
  class="fixed inset-x-0 bottom-0 z-40 flex items-center justify-between gap-x-4 rounded-t-2xl bg-muted p-4 md:hidden cursor-pointer border-t border-border/30"
>
  <div class="flex flex-col items-start">
    <div class="text-sm text-text/60">Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</div>
    <div class="text-text/90">
      <span class="font-bold">{{ cart.cart_final_price|floatformat|intcomma }}</span>
      <span class="text-sm">ØªÙˆÙ…Ø§Ù†</span>
    </div>
  </div>
  <button class="btn-primary px-6 py-3">Ø§Ø¯Ø§Ù…Ù‡ ÙØ±Ø§ÛŒÙ†Ø¯ Ø®Ø±ÛŒØ¯</button>
</div>
      {% endif %}

<!-- âœ… Bottom Sheet Menu (Hidden by default) -->
<div
  id="mobile-summary-drawer"
  class="fixed inset-0 z-50 hidden items-end justify-center bg-black/40 backdrop-blur-sm md:hidden"
>
  <div
    class="w-full max-w-md rounded-t-2xl bg-muted p-6 shadow-2xl animate-slide-up"
  >
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-base font-bold text-text">Ø¬Ø²Ø¦ÛŒØ§Øª Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</h2>
      <button id="close-drawer" class="p-2">
        <svg class="h-6 w-6 text-text/70">
          <use xlink:href="#close"></use>
        </svg>
      </button>
    </div>

    <!-- Details -->
    <div class="divide-y divide-border/30 mb-6">
      <div class="flex items-center justify-between py-3 text-sm">
        <span class="text-text/80">Ù‚ÛŒÙ…Øª Ú©Ø§Ù„Ø§Ù‡Ø§ ({{ cart.items.count }})</span>
        <span class="text-primary font-semibold">
          {{ cart.cart_org_total|floatformat|intcomma }} <span class="text-xs">ØªÙˆÙ…Ø§Ù†</span>
        </span>
      </div>
      <div class="flex items-center justify-between py-3 text-sm">
        <span class="text-text/80">ØªØ®ÙÛŒÙ</span>
        <span class="text-red-500 font-semibold">
          {{ cart.cart_discount|floatformat|intcomma }} <span class="text-xs">ØªÙˆÙ…Ø§Ù†</span>
        </span>
      </div>
      <div class="flex items-center justify-between py-3 text-sm">
        <span class="text-text/80">Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</span>
        <span class="text-primary font-bold text-lg">
          {{ cart.cart_final_price|floatformat|intcomma }} <span class="text-sm">ØªÙˆÙ…Ø§Ù†</span>
        </span>
      </div>
    </div>

    <!-- Continue Button -->
    <a
            {% if user.is_authenticated %}
            id="checkout-btn-mobile"
            {% else %}
            href="{% url 'login' %}?next={% url 'cart' %}"
            {% endif %}

       class="btn-primary w-full py-3 text-center block">
      Ø§Ø¯Ø§Ù…Ù‡ ÙØ±Ø§ÛŒÙ†Ø¯ Ø®Ø±ÛŒØ¯
    </a>
  </div>
</div>

<!-- âœ… Animation -->
<style>
@keyframes slide-up {
  from { transform: translateY(100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.animate-slide-up { animation: slide-up 0.3s ease-out; }
</style>

<!-- âœ… JS Behavior -->
<script>
const bar = document.getElementById('mobile-summary-bar');
const drawer = document.getElementById('mobile-summary-drawer');
const closeBtn = document.getElementById('close-drawer');

bar.addEventListener('click', () => {
  drawer.classList.remove('hidden');
  drawer.classList.add('flex');
});

closeBtn.addEventListener('click', () => {
  drawer.classList.add('hidden');
  drawer.classList.remove('flex');
});

drawer.addEventListener('click', e => {
  if (e.target === drawer) {
    drawer.classList.add('hidden');
    drawer.classList.remove('flex');
  }
});
</script>

      </main>

<!-- Modal Overlay -->
<div
  id="checkout-modal"
  class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 backdrop-blur-sm"
>
  <!-- Modal Content -->
  <div class="w-full max-w-lg rounded-xl bg-muted p-6 shadow-2xl relative animate-slide-up mx-4 md:mx-0">
    <!-- Close Button -->
    <button id="close-modal" class="absolute top-4 left-4 p-2">
      <svg class="h-6 w-6 text-text/70">
        <use xlink:href="#close"></use>
      </svg>
    </button>

    <!-- Title -->
    <h2 class="text-xl font-bold text-primary mb-4">ÙØ±Ù… Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</h2>

    <!-- Form -->
    <form action="{% url 'order-create' %}" method="post" class="space-y-4">
      {% csrf_token %}
        {% if is_physical %}
      <input type="text" name="full_name" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" required class="w-full rounded-lg border border-border px-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary"/>
      <input type="tel" name="phone_number" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" required class="w-full rounded-lg border border-border px-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary"/>
      <input type="text" name="telegram_id" placeholder="Ø¢ÛŒØ¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…" class="w-full rounded-lg border border-border px-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary"/>
      <input type="text" name="province" placeholder="Ø§Ø³ØªØ§Ù†" required class="w-full rounded-lg border border-border px-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary"/>
      <input type="text" name="city" placeholder="Ø´Ù‡Ø±" required class="w-full rounded-lg border border-border px-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary"/>
      <input type="text" name="postal_code" placeholder="Ú©Ø¯ Ù¾Ø³ØªÛŒ" required class="w-full rounded-lg border border-border px-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary"/>
      <textarea name="address" placeholder="Ø¢Ø¯Ø±Ø³ Ø¯Ù‚ÛŒÙ‚" required rows="3" class="w-full rounded-lg border border-border px-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary"></textarea>
      <textarea name="description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" rows="2" class="w-full rounded-lg border border-border px-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary"></textarea>
        {% else %}
      <input type="text" name="full_name" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" required class="w-full rounded-lg border border-border px-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary"/>
      <input type="tel" name="phone_number" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" required class="w-full rounded-lg border border-border px-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary"/>
      <input type="text" name="telegram_id" placeholder="Ø¢ÛŒØ¯ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…" class="w-full rounded-lg border border-border px-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary"/>
      <textarea name="description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" rows="2" class="w-full rounded-lg border border-border px-4 py-2 focus:border-primary focus:ring-1 focus:ring-primary"></textarea>
        {% endif %}
      <button type="submit" class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-primary/90 transition-colors">Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´</button>
    </form>
  </div>
</div>

<!-- Animation -->
<style>
@keyframes slide-up {
  from { transform: translateY(100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.animate-slide-up { animation: slide-up 0.3s ease-out; }
</style>


<script>
const checkoutModal = document.getElementById('checkout-modal');
const closeModal = document.getElementById('close-modal');

// Ù‡Ø± Ø¯Ùˆ Ø¯Ú©Ù…Ù‡
const checkoutBtns = [
  document.getElementById('checkout-btn-desktop'),
  document.getElementById('checkout-btn-mobile')
];

// Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„
checkoutBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    checkoutModal.classList.remove('hidden');
    checkoutModal.classList.add('flex');
  });
});

// Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
closeModal.addEventListener('click', () => {
  checkoutModal.classList.add('hidden');
  checkoutModal.classList.remove('flex');
});

// Ø¨Ø³ØªÙ† Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù¾Ø´Øª Ø²Ù…ÛŒÙ†Ù‡
checkoutModal.addEventListener('click', e => {
  if (e.target === checkoutModal) {
    checkoutModal.classList.add('hidden');
    checkoutModal.classList.remove('flex');
  }
});
</script>


{% endblock %}
